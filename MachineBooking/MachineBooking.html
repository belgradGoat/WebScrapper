<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Machine Shop Scheduler</title>
    
    <!-- React and Babel CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <style>
        .part-block {
            position: absolute;
            top: 4px;
            bottom: 4px;
        }
        .resize-handle {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 8px;
            cursor: ew-resize;
            background: rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.2s;
        }
        .part-block:hover .resize-handle {
            opacity: 1;
        }
        .time-slot {
            min-width: 60px;
            position: relative;
        }
        .machine-row {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
        }
        .schedule-container {
            overflow-x: auto;
            overflow-y: hidden;
        }
        .part-indicator {
            position: absolute;
            top: -8px;
            left: -8px;
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            z-index: 20;
            border: 2px solid white;
        }
        .day-container {
            position: relative;
            display: flex;
            height: 80px;
        }
        .job-group-indicator {
            width: 4px;
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            border-radius: 2px 0 0 2px;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, Fragment } = React;
        
        // Lucide icon components wrapper
        const LucideIcon = ({ name, className }) => {
            useEffect(() => {
                lucide.createIcons();
            }, []);
            return <i data-lucide={name} className={className}></i>;
        };
        
        const Plus = (props) => <LucideIcon name="plus" {...props} />;
        const Edit3 = (props) => <LucideIcon name="edit-3" {...props} />;
        const Save = (props) => <LucideIcon name="save" {...props} />;
        const X = (props) => <LucideIcon name="x" {...props} />;
        const Clock = (props) => <LucideIcon name="clock" {...props} />;
        const Wrench = (props) => <LucideIcon name="wrench" {...props} />;
        const Calendar = (props) => <LucideIcon name="calendar" {...props} />;
        const Package = (props) => <LucideIcon name="package" {...props} />;
        const Copy = (props) => <LucideIcon name="copy" {...props} />;

        const MachineShopScheduler = () => {
            // Component state
            const [machines, setMachines] = useState([
                { id: 1, name: 'Hermle 1', type: 'Milling' },
                { id: 2, name: 'Hermle 2', type: 'Milling' },
                { id: 3, name: 'Hermle 3', type: 'Milling' },
                { id: 4, name: 'Hermle 4', type: 'Milling' },
                { id: 5, name: 'Hermle 5', type: 'Milling' },
                { id: 6, name: 'Hermle 6', type: 'Milling' },
            ]);

            // Jobs are the parent containers
            const [jobs, setJobs] = useState([
                { 
                    id: 'job-1',
                    name: 'Part A-123',
                    totalParts: 3,
                    cycleTime: 1.8,
                    color: '#fbbf24', // amber
                    createdAt: Date.now()
                },
                { 
                    id: 'job-2',
                    name: 'Bracket B-456',
                    totalParts: 2,
                    cycleTime: 2.4,
                    color: '#60a5fa', // blue
                    createdAt: Date.now()
                },
                { 
                    id: 'job-3',
                    name: 'Shaft C-789',
                    totalParts: 4,
                    cycleTime: 1.2,
                    color: '#34d399', // green
                    createdAt: Date.now()
                }
            ]);

            // Parts are the individual schedulable items
            const [parts, setParts] = useState([
                // Job 1 parts
                { id: 'part-1-1', jobId: 'job-1', partNumber: 1, machineId: 1, startTime: new Date().setHours(8, 0, 0, 0), estimate: true, status: 'scheduled' },
                { id: 'part-1-2', jobId: 'job-1', partNumber: 2, machineId: 1, startTime: new Date().setHours(10, 0, 0, 0), estimate: true, status: 'scheduled' },
                { id: 'part-1-3', jobId: 'job-1', partNumber: 3, machineId: 1, startTime: new Date().setHours(12, 0, 0, 0), estimate: true, status: 'scheduled' },
                // Job 2 parts
                { id: 'part-2-1', jobId: 'job-2', partNumber: 1, machineId: 2, startTime: new Date().setHours(9, 0, 0, 0), estimate: true, status: 'scheduled' },
                { id: 'part-2-2', jobId: 'job-2', partNumber: 2, machineId: 2, startTime: new Date().setHours(11, 30, 0, 0), estimate: true, status: 'scheduled' },
                // Job 3 parts
                { id: 'part-3-1', jobId: 'job-3', partNumber: 1, machineId: 3, startTime: new Date().setHours(8, 0, 0, 0), estimate: false, status: 'in-progress' },
                { id: 'part-3-2', jobId: 'job-3', partNumber: 2, machineId: 3, startTime: new Date().setHours(9, 30, 0, 0), estimate: false, status: 'scheduled' },
                { id: 'part-3-3', jobId: 'job-3', partNumber: 3, machineId: 3, startTime: new Date().setHours(11, 0, 0, 0), estimate: false, status: 'scheduled' },
                { id: 'part-3-4', jobId: 'job-3', partNumber: 4, machineId: 3, startTime: new Date().setHours(12, 30, 0, 0), estimate: false, status: 'scheduled' },
            ]);

            const [newJob, setNewJob] = useState({ 
                name: '', 
                machineId: '', 
                totalParts: 1,
                cycleTime: 1.0,
                startDate: new Date().toISOString().split('T')[0],
                startHour: 8,
                startMinute: 0
            });
            const [showNewJobForm, setShowNewJobForm] = useState(false);
            const [editingPart, setEditingPart] = useState(null);
            const [draggedPart, setDraggedPart] = useState(null);
            const [selectedWeek, setSelectedWeek] = useState(() => {
                // Start with today as the first day shown
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                return today.getTime();
            });
            const [selectedJob, setSelectedJob] = useState(null);

            // Color palette for new jobs
            const colorPalette = [
                '#ef4444', // red
                '#f97316', // orange
                '#fbbf24', // amber
                '#84cc16', // lime
                '#22c55e', // green
                '#10b981', // emerald
                '#14b8a6', // teal
                '#06b6d4', // cyan
                '#0ea5e9', // sky
                '#3b82f6', // blue
                '#6366f1', // indigo
                '#8b5cf6', // violet
                '#a855f7', // purple
                '#d946ef', // fuchsia
                '#ec4899', // pink
                '#f43f5e', // rose
            ];

            // Get start of week (Monday)
            function getWeekStart(date) {
                const d = new Date(date);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                return new Date(d.setDate(diff)).setHours(0, 0, 0, 0);
            }

            // Get week start from any date (keeps the date in the middle of the week view)
            function getWeekStartFromDate(date) {
                // Just return the date at midnight
                const d = new Date(date);
                d.setHours(0, 0, 0, 0);
                return d.getTime();
            }

            // Get week days
            function getWeekDays(weekStart) {
                const days = [];
                const startDate = new Date(weekStart);
                for (let i = 0; i < 7; i++) {
                    const day = new Date(startDate);
                    day.setDate(startDate.getDate() + i);
                    days.push(day);
                }
                return days;
            }

            // Format time display
            const formatTime = (hour) => {
                return `${hour.toString().padStart(2, '0')}:00`;
            };

            // Format date for display
            const formatDate = (date) => {
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                return `${days[date.getDay()]} ${date.getDate()} ${months[date.getMonth()]}`;
            };

            // Get job by ID
            const getJob = (jobId) => {
                return jobs.find(job => job.id === jobId);
            };

            // Get parts for a specific job
            const getJobParts = (jobId) => {
                return parts.filter(part => part.jobId === jobId).sort((a, b) => a.partNumber - b.partNumber);
            };

            // Add new job with parts
            const addJob = () => {
                if (newJob.name && newJob.machineId && newJob.totalParts > 0) {
                    const jobId = `job-${Date.now()}`;
                    const jobColor = colorPalette[jobs.length % colorPalette.length];
                    
                    // Create the job
                    const job = {
                        id: jobId,
                        name: newJob.name,
                        totalParts: parseInt(newJob.totalParts),
                        cycleTime: parseFloat(newJob.cycleTime),
                        color: jobColor,
                        createdAt: Date.now()
                    };
                    
                    console.log('Creating job:', job);
                    console.log('Selected week starts:', new Date(selectedWeek));
                    
                    // Create parts for the job
                    const newParts = [];
                    const startDateTime = new Date(newJob.startDate);
                    startDateTime.setHours(newJob.startHour, newJob.startMinute, 0, 0);
                    let currentTime = startDateTime.getTime();
                    
                    console.log('Start date/time for parts:', new Date(currentTime));
                    console.log('Week days:', weekDays.map(d => d.toISOString()));
                    
                    for (let i = 0; i < job.totalParts; i++) {
                        const part = {
                            id: `part-${jobId}-${i + 1}`,
                            jobId: jobId,
                            partNumber: i + 1,
                            machineId: parseInt(newJob.machineId),
                            startTime: currentTime,
                            estimate: true,
                            status: 'scheduled'
                        };
                        console.log(`Part ${i + 1} will start at:`, new Date(currentTime));
                        newParts.push(part);
                        // Add cycle time for next part
                        currentTime += job.cycleTime * 60 * 1000;
                    }
                    
                    setJobs([...jobs, job]);
                    setParts([...parts, ...newParts]);
                    
                    setNewJob({ 
                        name: '', 
                        machineId: '', 
                        totalParts: 1,
                        cycleTime: 1.0,
                        startDate: new Date().toISOString().split('T')[0],
                        startHour: 8,
                        startMinute: 0
                    });
                    setShowNewJobForm(false);
                }
            };

            // Update part
            const updatePart = (partId, updates) => {
                setParts(parts.map(part => part.id === partId ? { ...part, ...updates } : part));
            };

            // Delete job and all its parts
            const deleteJob = (jobId) => {
                setJobs(jobs.filter(job => job.id !== jobId));
                setParts(parts.filter(part => part.jobId !== jobId));
                if (selectedJob?.id === jobId) {
                    setSelectedJob(null);
                }
            };

            // Delete individual part
            const deletePart = (partId) => {
                const part = parts.find(p => p.id === partId);
                if (part) {
                    const job = getJob(part.jobId);
                    const jobParts = getJobParts(part.jobId);
                    
                    if (jobParts.length === 1) {
                        // Last part, delete the whole job
                        deleteJob(part.jobId);
                    } else {
                        // Remove the part and update part numbers
                        const remainingParts = parts.filter(p => p.id !== partId);
                        const updatedParts = remainingParts.map(p => {
                            if (p.jobId === part.jobId && p.partNumber > part.partNumber) {
                                return { ...p, partNumber: p.partNumber - 1 };
                            }
                            return p;
                        });
                        setParts(updatedParts);
                        
                        // Update job total parts
                        setJobs(jobs.map(j => 
                            j.id === part.jobId 
                                ? { ...j, totalParts: j.totalParts - 1 }
                                : j
                        ));
                    }
                }
            };

            // Handle drag start
            const handleDragStart = (e, part) => {
                setDraggedPart(part);
                e.dataTransfer.effectAllowed = 'move';
            };

            // Handle drag over
            const handleDragOver = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            };

            // Handle drop
            const handleDrop = (e, machineId, hour, day) => {
                e.preventDefault();
                if (draggedPart) {
                    const dropTime = new Date(day);
                    dropTime.setHours(hour, 0, 0, 0);
                    
                    updatePart(draggedPart.id, { 
                        machineId: machineId, 
                        startTime: dropTime.getTime()
                    });
                    setDraggedPart(null);
                }
            };

            // Get parts for a specific machine and day
            const getPartsForDay = (machineId, day) => {
                const dayStart = new Date(day).setHours(0, 0, 0, 0);
                const dayEnd = dayStart + 24 * 60 * 60 * 1000;
                
                return parts.filter(part => {
                    const job = getJob(part.jobId);
                    if (!job) return false;
                    
                    const partEnd = part.startTime + job.cycleTime * 60 * 1000;
                    return part.machineId === machineId &&
                           ((part.startTime >= dayStart && part.startTime < dayEnd) ||
                            (partEnd > dayStart && partEnd <= dayEnd) ||
                            (part.startTime < dayStart && partEnd > dayEnd));
                });
            };

            // Calculate machine utilization for the week
            const getMachineUtilization = (machineId) => {
                const weekStart = selectedWeek;
                const weekEnd = weekStart + 7 * 24 * 60 * 60 * 1000;
                
                const weekParts = parts.filter(part => {
                    return part.machineId === machineId && 
                           part.startTime >= weekStart && 
                           part.startTime < weekEnd;
                });
                
                const totalMinutes = weekParts.reduce((sum, part) => {
                    const job = getJob(part.jobId);
                    return sum + (job ? job.cycleTime : 0);
                }, 0);
                
                const weekMinutes = 7 * 24 * 60; // Total minutes in a week
                return Math.round((totalMinutes / weekMinutes) * 100);
            };

            // Duplicate a part
            const duplicatePart = (part) => {
                const job = getJob(part.jobId);
                if (!job) return;
                
                const newPartId = `part-${part.jobId}-${Date.now()}`;
                const jobParts = getJobParts(part.jobId);
                const newPartNumber = Math.max(...jobParts.map(p => p.partNumber)) + 1;
                
                const newPart = {
                    ...part,
                    id: newPartId,
                    partNumber: newPartNumber,
                    startTime: part.startTime + job.cycleTime * 60 * 1000
                };
                
                setParts([...parts, newPart]);
                setJobs(jobs.map(j => 
                    j.id === part.jobId 
                        ? { ...j, totalParts: j.totalParts + 1 }
                        : j
                ));
            };

            const weekDays = getWeekDays(selectedWeek);

            // Job Details Panel
            const JobDetailsPanel = ({ job, onClose }) => {
                const jobParts = getJobParts(job.id);
                const machineBreakdown = jobParts.reduce((acc, part) => {
                    const machine = machines.find(m => m.id === part.machineId);
                    if (machine) {
                        acc[machine.name] = (acc[machine.name] || 0) + 1;
                    }
                    return acc;
                }, {});
                
                return (
                    <div className="fixed right-0 top-0 h-full w-96 bg-white shadow-lg z-50 overflow-y-auto">
                        <div className="p-6">
                            <div className="flex justify-between items-start mb-4">
                                <div>
                                    <h2 className="text-2xl font-bold" style={{ color: job.color }}>{job.name}</h2>
                                    <p className="text-gray-600">{job.totalParts} parts × {job.cycleTime} min/part</p>
                                </div>
                                <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
                                    <X className="h-6 w-6" />
                                </button>
                            </div>
                            
                            <div className="mb-6">
                                <h3 className="font-semibold mb-2">Machine Distribution</h3>
                                <div className="space-y-2">
                                    {Object.entries(machineBreakdown).map(([machine, count]) => (
                                        <div key={machine} className="flex justify-between text-sm">
                                            <span>{machine}</span>
                                            <span className="font-medium">{count} parts</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            
                            <div>
                                <h3 className="font-semibold mb-2">Parts Schedule</h3>
                                <div className="space-y-2">
                                    {jobParts.map(part => {
                                        const machine = machines.find(m => m.id === part.machineId);
                                        return (
                                            <div key={part.id} className="border rounded p-3">
                                                <div className="flex justify-between items-start">
                                                    <div>
                                                        <span className="font-medium">Part {part.partNumber}</span>
                                                        <p className="text-sm text-gray-600">{machine?.name}</p>
                                                        <p className="text-xs text-gray-500">
                                                            {new Date(part.startTime).toLocaleString()}
                                                        </p>
                                                    </div>
                                                    <span className={`text-xs px-2 py-1 rounded ${
                                                        part.status === 'in-progress' 
                                                            ? 'bg-green-100 text-green-800'
                                                            : part.estimate 
                                                                ? 'bg-yellow-100 text-yellow-800'
                                                                : 'bg-blue-100 text-blue-800'
                                                    }`}>
                                                        {part.status === 'in-progress' ? 'In Progress' : part.estimate ? 'Estimate' : 'Confirmed'}
                                                    </span>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                            
                            <div className="mt-6 pt-6 border-t">
                                <button
                                    onClick={() => {
                                        if (confirm(`Delete job "${job.name}" and all ${job.totalParts} parts?`)) {
                                            deleteJob(job.id);
                                            onClose();
                                        }
                                    }}
                                    className="w-full bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition-colors"
                                >
                                    Delete Job
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-gray-50 p-6">
                    <div className="mx-auto" style={{ maxWidth: '1600px' }}>
                        {/* Header */}
                        <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
                            <div className="flex items-center justify-between mb-4">
                                <div className="flex items-center space-x-3">
                                    <Wrench className="h-8 w-8 text-blue-600" />
                                    <h1 className="text-3xl font-bold text-gray-900">Machine Shop Scheduler</h1>
                                </div>
                                <div className="flex items-center space-x-4">
                                    <div className="flex items-center space-x-2">
                                        <button
                                            onClick={() => setSelectedWeek(selectedWeek - 7 * 24 * 60 * 60 * 1000)}
                                            className="p-2 hover:bg-gray-100 rounded"
                                        >
                                            ←
                                        </button>
                                        <Calendar className="h-5 w-5 text-gray-500" />
                                        <span className="font-medium">
                                             {formatDate(new Date(selectedWeek))} - {formatDate(new Date(selectedWeek + 6 * 24 * 60 * 60 * 1000))}
                                        </span>
                                        <button
                                            onClick={() => setSelectedWeek(selectedWeek + 7 * 24 * 60 * 60 * 1000)}
                                            className="p-2 hover:bg-gray-100 rounded"
                                        >
                                            →
                                        </button>
                                        <button
                                            onClick={() => setSelectedWeek(getWeekStartFromDate(new Date()))}
                                            className="px-3 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded"
                                            title="Go to today"
                                        >
                                            Today
                                        </button>
                                    </div>
                                    <button
                                        onClick={() => setShowNewJobForm(true)}
                                        className="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center space-x-2 hover:bg-blue-700 transition-colors"
                                    >
                                        <Plus className="h-4 w-4" />
                                        <span>Add Job</span>
                                    </button>
                                </div>
                            </div>

                            {/* Machine Stats */}
                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                                {machines.map(machine => (
                                    <div key={machine.id} className="bg-gray-50 rounded-lg p-4">
                                        <h3 className="font-semibold text-gray-900">{machine.name}</h3>
                                        <p className="text-sm text-gray-600">{machine.type}</p>
                                        <div className="mt-2">
                                            <div className="flex justify-between text-sm">
                                                <span>Utilization</span>
                                                <span>{getMachineUtilization(machine.id)}%</span>
                                            </div>
                                            <div className="w-full bg-gray-200 rounded-full h-2 mt-1">
                                                <div 
                                                    className="bg-blue-600 h-2 rounded-full transition-all duration-300" 
                                                    style={{ width: `${getMachineUtilization(machine.id)}%` }}
                                                ></div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Jobs Overview */}
                        <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
                            <h2 className="text-xl font-semibold mb-4">Active Jobs</h2>
                            <div className="flex flex-wrap gap-2">
                                {jobs.map(job => {
                                    const jobParts = getJobParts(job.id);
                                    const completedParts = jobParts.filter(p => p.status === 'completed').length;
                                    const inProgressParts = jobParts.filter(p => p.status === 'in-progress').length;
                                    
                                    return (
                                        <button
                                            key={job.id}
                                            onClick={() => setSelectedJob(job)}
                                            className="px-4 py-2 rounded-lg text-white font-medium hover:opacity-90 transition-opacity relative"
                                            style={{ backgroundColor: job.color }}
                                        >
                                            <div className="flex items-center space-x-2">
                                                <Package className="h-4 w-4" />
                                                <span>{job.name}</span>
                                                <span className="text-xs opacity-75">
                                                    ({completedParts}/{job.totalParts})
                                                </span>
                                            </div>
                                            {inProgressParts > 0 && (
                                                <div className="absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                                            )}
                                        </button>
                                    );
                                })}
                            </div>
                        </div>

                        {/* New Job Form */}
                        {showNewJobForm && (
                            <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
                                <h2 className="text-xl font-semibold mb-4">Add New Job</h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    <input
                                        type="text"
                                        placeholder="Job Name"
                                        value={newJob.name}
                                        onChange={(e) => setNewJob({...newJob, name: e.target.value})}
                                        className="border border-gray-300 rounded-md px-3 py-2"
                                    />
                                    <select
                                        value={newJob.machineId}
                                        onChange={(e) => setNewJob({...newJob, machineId: e.target.value})}
                                        className="border border-gray-300 rounded-md px-3 py-2"
                                    >
                                        <option value="">Select Initial Machine</option>
                                        {machines.map(machine => (
                                            <option key={machine.id} value={machine.id}>{machine.name}</option>
                                        ))}
                                    </select>
                                    <input
                                        type="number"
                                        placeholder="Number of Parts"
                                        min="1"
                                        value={newJob.totalParts}
                                        onChange={(e) => setNewJob({...newJob, totalParts: parseInt(e.target.value) || 1})}
                                        className="border border-gray-300 rounded-md px-3 py-2"
                                    />
                                    <input
                                        type="number"
                                        placeholder="Cycle Time (min/part)"
                                        min="0.1"
                                        step="0.1"
                                        value={newJob.cycleTime}
                                        onChange={(e) => setNewJob({...newJob, cycleTime: parseFloat(e.target.value) || 1})}
                                        className="border border-gray-300 rounded-md px-3 py-2"
                                    />
                                    <input
                                        type="date"
                                        value={newJob.startDate}
                                        onChange={(e) => setNewJob({...newJob, startDate: e.target.value})}
                                        className="border border-gray-300 rounded-md px-3 py-2"
                                    />
                                    <div className="flex space-x-2">
                                        <input
                                            type="number"
                                            placeholder="Hour"
                                            min="0"
                                            max="23"
                                            value={newJob.startHour}
                                            onChange={(e) => setNewJob({...newJob, startHour: parseInt(e.target.value) || 0})}
                                            className="border border-gray-300 rounded-md px-3 py-2 w-20"
                                        />
                                        <input
                                            type="number"
                                            placeholder="Min"
                                            min="0"
                                            max="59"
                                            value={newJob.startMinute}
                                            onChange={(e) => setNewJob({...newJob, startMinute: parseInt(e.target.value) || 0})}
                                            className="border border-gray-300 rounded-md px-3 py-2 w-20"
                                        />
                                    </div>
                                    <div className="text-sm text-gray-600 p-2">
                                        Total Time: {(newJob.totalParts * newJob.cycleTime).toFixed(1)} minutes 
                                        ({(newJob.totalParts * newJob.cycleTime / 60).toFixed(1)} hours)
                                    </div>
                                    <div className="flex space-x-2">
                                        <button
                                            onClick={addJob}
                                            className="bg-green-600 text-white px-4 py-2 rounded-md flex-1 hover:bg-green-700 transition-colors"
                                        >
                                            <Save className="h-4 w-4 inline mr-2" />
                                            Add
                                        </button>
                                        <button
                                            onClick={() => setShowNewJobForm(false)}
                                            className="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition-colors"
                                        >
                                            <X className="h-4 w-4" />
                                        </button>
                                    </div>
                                </div>
                                <p className="text-sm text-gray-600 mt-2">
                                    All parts will be initially scheduled on the selected machine. You can drag individual parts to different machines after creation.
                                </p>
                            </div>
                        )}

                        {/* Horizontal Swimlane Schedule */}
                        <div className="bg-white rounded-lg shadow-sm overflow-hidden">
                            <div className="schedule-container">
                                {/* Time Header */}
                                <div className="sticky top-0 z-20 bg-white border-b">
                                    <div className="flex">
                                        <div className="w-32 flex-shrink-0 p-4 bg-gray-100 font-semibold border-r">
                                            Machine
                                        </div>
                                        {weekDays.map(day => (
                                            <div key={day.toISOString()} className="flex-shrink-0 border-r">
                                                <div className={`p-2 text-center font-medium border-b ${
                                                    day.toDateString() === new Date().toDateString() 
                                                        ? 'bg-blue-100 text-blue-800' 
                                                        : 'bg-gray-100'
                                                }`}>
                                                    {formatDate(day)}
                                                    {day.toDateString() === new Date().toDateString() && (
                                                        <span className="ml-2 text-xs font-normal">(Today)</span>
                                                    )}
                                                </div>
                                                <div className="flex">
                                                    {Array.from({ length: 24 }, (_, h) => (
                                                        <div key={h} className="time-slot text-xs text-center p-1 border-r border-gray-200">
                                                            {formatTime(h)}
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* Machine Rows */}
                                {machines.map(machine => (
                                    <div key={machine.id} className="machine-row">
                                        <div className="w-32 flex-shrink-0 p-4 bg-gray-50 border-r font-medium">
                                            <div>{machine.name}</div>
                                            <div className="text-sm text-gray-600">{machine.type}</div>
                                        </div>
                                        {weekDays.map(day => (
                                            <div key={day.toISOString()} className="day-container flex-shrink-0 border-r">
                                                {Array.from({ length: 24 }, (_, hour) => (
                                                    <div
                                                        key={hour}
                                                        className="time-slot border-r border-gray-200 hover:bg-blue-50"
                                                        onDragOver={handleDragOver}
                                                        onDrop={(e) => handleDrop(e, machine.id, hour, day)}
                                                    />
                                                ))}
                                                {/* Render parts for this machine and day */}
                                                {getPartsForDay(machine.id, day).map(part => {
                                                    const job = getJob(part.jobId);
                                                    if (!job) return null;
                                                    
                                                    const dayStart = new Date(day).setHours(0, 0, 0, 0);
                                                    const startOffset = Math.max(0, (part.startTime - dayStart) / (1000 * 60 * 60)); // hours from day start
                                                    const pixelOffset = startOffset * 60; // 60px per hour
                                                    const width = (job.cycleTime / 60) * 60; // convert minutes to pixels
                                                    
                                                    return (
                                                        <div
                                                            key={part.id}
                                                            draggable
                                                            onDragStart={(e) => handleDragStart(e, part)}
                                                            className={`part-block rounded cursor-move transition-all duration-200 ${
                                                                part.status === 'scheduled' 
                                                                    ? part.estimate 
                                                                        ? 'bg-opacity-70' 
                                                                        : 'bg-opacity-90'
                                                                    : 'bg-opacity-100 ring-2 ring-green-500'
                                                            }`}
                                                            style={{ 
                                                                left: `${pixelOffset}px`,
                                                                width: `${width}px`,
                                                                backgroundColor: job.color,
                                                                zIndex: 10
                                                            }}
                                                        >
                                                            <div className="part-indicator">
                                                                {part.partNumber}
                                                            </div>
                                                            <div 
                                                                className="job-group-indicator"
                                                                style={{ backgroundColor: job.color }}
                                                            ></div>
                                                            <div className="p-1 pl-3 h-full flex flex-col justify-between overflow-hidden">
                                                                <div>
                                                                    <div className="font-semibold text-xs truncate text-white">
                                                                        {job.name}
                                                                    </div>
                                                                    <div className="text-xs text-white opacity-90">
                                                                        Part {part.partNumber}/{job.totalParts}
                                                                    </div>
                                                                </div>
                                                                <div className="flex justify-between items-center">
                                                                    <span className={`text-xs px-1 rounded ${
                                                                        part.status === 'in-progress'
                                                                            ? 'bg-green-100 text-green-800'
                                                                            : part.estimate 
                                                                                ? 'bg-yellow-100 text-yellow-800' 
                                                                                : 'bg-blue-100 text-blue-800'
                                                                    }`}>
                                                                        {part.status === 'in-progress' ? 'WIP' : part.estimate ? 'est' : 'conf'}
                                                                    </span>
                                                                    <div className="flex space-x-1">
                                                                        <button
                                                                            onClick={(e) => {
                                                                                e.stopPropagation();
                                                                                duplicatePart(part);
                                                                            }}
                                                                            className="text-white hover:text-yellow-200"
                                                                            title="Duplicate Part"
                                                                        >
                                                                            <Copy className="h-3 w-3" />
                                                                        </button>
                                                                        <button
                                                                            onClick={(e) => {
                                                                                e.stopPropagation();
                                                                                setEditingPart(part);
                                                                            }}
                                                                            className="text-white hover:text-yellow-200"
                                                                        >
                                                                            <Edit3 className="h-3 w-3" />
                                                                        </button>
                                                                        <button
                                                                            onClick={(e) => {
                                                                                e.stopPropagation();
                                                                                if (confirm(`Delete part ${part.partNumber} of ${job.name}?`)) {
                                                                                    deletePart(part.id);
                                                                                }
                                                                            }}
                                                                            className="text-white hover:text-red-300"
                                                                        >
                                                                            <X className="h-3 w-3" />
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        ))}
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Legend and Summary */}
                        <div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="bg-white rounded-lg shadow-sm p-4">
                                <h3 className="font-semibold mb-3">Legend</h3>
                                <div className="space-y-2">
                                    <div className="flex items-center space-x-2">
                                        <div className="w-8 h-8 bg-gray-400 bg-opacity-70 rounded relative">
                                            <div className="part-indicator" style={{ position: 'absolute', top: '-4px', left: '-4px' }}>1</div>
                                        </div>
                                        <span className="text-sm">Part number indicator</span>
                                    </div>
                                    <div className="flex items-center space-x-2">
                                        <div className="w-8 h-8 bg-yellow-400 bg-opacity-70 rounded flex items-center justify-center">
                                            <span className="text-xs font-bold">est</span>
                                        </div>
                                        <span className="text-sm">Estimated time</span>
                                    </div>
                                    <div className="flex items-center space-x-2">
                                        <div className="w-8 h-8 bg-blue-400 bg-opacity-90 rounded flex items-center justify-center">
                                            <span className="text-xs font-bold text-white">conf</span>
                                        </div>
                                        <span className="text-sm">Confirmed time</span>
                                    </div>
                                    <div className="flex items-center space-x-2">
                                        <div className="w-8 h-8 bg-green-400 rounded ring-2 ring-green-500 flex items-center justify-center">
                                            <span className="text-xs font-bold text-white">WIP</span>
                                        </div>
                                        <span className="text-sm">Work in progress</span>
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white rounded-lg shadow-sm p-4">
                                <h3 className="font-semibold mb-3">Week Summary</h3>
                                <div className="grid grid-cols-3 gap-4">
                                    <div>
                                        <div className="text-2xl font-bold text-blue-600">{jobs.length}</div>
                                        <div className="text-sm text-gray-600">Total Jobs</div>
                                    </div>
                                    <div>
                                        <div className="text-2xl font-bold text-yellow-600">{parts.length}</div>
                                        <div className="text-sm text-gray-600">Total Parts</div>
                                    </div>
                                    <div>
                                        <div className="text-2xl font-bold text-green-600">
                                            {(parts.reduce((sum, part) => {
                                                const job = getJob(part.jobId);
                                                return sum + (job ? job.cycleTime : 0);
                                            }, 0) / 60).toFixed(1)}h
                                        </div>
                                        <div className="text-sm text-gray-600">Total Hours</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Job Details Panel */}
                    {selectedJob && (
                        <JobDetailsPanel 
                            job={selectedJob} 
                            onClose={() => setSelectedJob(null)} 
                        />
                    )}

                    {/* Edit Part Modal */}
                    {editingPart && (() => {
                        const job = getJob(editingPart.jobId);
                        if (!job) return null;
                        
                        return (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                                <div className="bg-white rounded-lg p-6 w-full max-w-md">
                                    <h3 className="text-lg font-semibold mb-4">
                                        Edit Part {editingPart.partNumber} of {job.name}
                                    </h3>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Machine</label>
                                            <select
                                                value={editingPart.machineId}
                                                onChange={(e) => setEditingPart({...editingPart, machineId: parseInt(e.target.value)})}
                                                className="w-full border border-gray-300 rounded-md px-3 py-2"
                                            >
                                                {machines.map(machine => (
                                                    <option key={machine.id} value={machine.id}>{machine.name}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium mb-1">Status</label>
                                            <select
                                                value={editingPart.status}
                                                onChange={(e) => setEditingPart({...editingPart, status: e.target.value})}
                                                className="w-full border border-gray-300 rounded-md px-3 py-2"
                                            >
                                                <option value="scheduled">Scheduled</option>
                                                <option value="in-progress">In Progress</option>
                                                <option value="completed">Completed</option>
                                            </select>
                                        </div>
                                        <div className="flex items-center">
                                            <input
                                                type="checkbox"
                                                checked={!editingPart.estimate}
                                                onChange={(e) => setEditingPart({...editingPart, estimate: !e.target.checked})}
                                                className="mr-2"
                                            />
                                            <label className="text-sm">Confirmed time (not estimate)</label>
                                        </div>
                                        <div className="text-sm text-gray-600 p-2 bg-gray-50 rounded">
                                            Cycle Time: {job.cycleTime} minutes
                                        </div>
                                        <div className="flex space-x-2 pt-4">
                                            <button
                                                onClick={() => {
                                                    updatePart(editingPart.id, editingPart);
                                                    setEditingPart(null);
                                                }}
                                                className="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors"
                                            >
                                                Save Changes
                                            </button>
                                            <button
                                                onClick={() => setEditingPart(null)}
                                                className="flex-1 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition-colors"
                                            >
                                                Cancel
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        );
                    })()}
                </div>
            );
        };

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MachineShopScheduler />);
    </script>
</body>
</html>